name: systemd
variant: scratch
shell: /bin/bash
dependencies:
  - stage: base
steps:
  - sources:
      - url: https://github.com/systemd/systemd/archive/refs/tags/v{{ .systemd_version }}.tar.gz
        destination: systemd.tar.gz
        sha256: "{{ .systemd_sha256 }}"
        sha512: "{{ .systemd_sha512 }}"
    env:
      SOURCE_DATE_EPOCH: {{ .BUILD_ARG_SOURCE_DATE_EPOCH }}
      CC: "gcc -D__UAPI_DEF_ETHHDR=0 -D_LARGEFILE64_SOURCE -D__DEFINED_wchar_t"
    prepare:
      - |
        mkdir -p /tmp/systemd
        tar -xzf systemd.tar.gz --strip-components=1 -C /tmp/systemd
        cd /tmp/systemd

        # Patches for musl from openembedded-core, MIT licensed
        # https://patchwork.yoctoproject.org/project/oe-core/patch/20251016084700.1537381-2-Qi.Chen@windriver.com/
        patch -p1 < /pkg/patches/0001-binfmt-Don-t-install-dependency-links-at-install-tim.patch
        patch -p1 < /pkg/patches/0001-systemctl-Call-systemd-sysv-install-without-path.patch
        patch -p1 < /pkg/patches/0002-implment-systemd-sysv-install-for-OE.patch
        patch -p1 < /pkg/patches/0003-Do-not-create-var-log-README.patch
        patch -p1 < /pkg/patches/0004-musl.h-introduce-header-file-and-add-__THROW.patch
        patch -p1 < /pkg/patches/0005-add-fallback-parse_printf_format-implementation.patch
        patch -p1 < /pkg/patches/0006-Make-mallinfo-related-contents-glibc-specific.patch
        patch -p1 < /pkg/patches/0007-add-src-include-override-sys-prctl.h-to-avoid-redefi.patch
        patch -p1 < /pkg/patches/0008-distinguish-XSI-compliant-strerror_r-from-GNU-specif.patch
        patch -p1 < /pkg/patches/0009-errno-util-Make-STRERROR-portable-for-musl.patch
        patch -p1 < /pkg/patches/0010-src-basic-format-util.h-define-RLIM_FMT-to-fit-musl-.patch
        patch -p1 < /pkg/patches/0011-src-include-override-malloc.h-define-dummy-malloc_tr.patch
        patch -p1 < /pkg/patches/0012-src-shared-condition.c-avoid-using-glibc-ConditionVe.patch
        patch -p1 < /pkg/patches/0013-build-path.c-avoid-boot-time-segfault-for-musl.patch
        patch -p1 < /pkg/patches/0014-Handle-missing-gshadow-for-musl.patch
        patch -p1 < /pkg/patches/0015-Avoid-sequence-point-error.patch
        patch -p1 < /pkg/patches/0016-Fix-the-segfault-for-glob-related-codes-and-define-d.patch
        patch -p1 < /pkg/patches/0017-Always-include-netinet-if_ether.h-first.patch

        # Own fixes for musl
        patch -p1 < /pkg/patches/0001-chore-musl-headers-compatibility-for-udev.patch
        patch -p1 < /pkg/patches/tmp.patch
        patch -p1 < /pkg/patches/0001-Revert-stat-util-drop-statx_fallback.patch
        patch -p1 < /pkg/patches/0002-Revert-tree-wide-drop-workarounds-for-statx.patch
        patch -p1 < /pkg/patches/musl.patch

        meson setup build \
          --buildtype=release \
          -Dmode=release \
          -Dlibdir=/usr/lib \
          -Dversion-tag="{{ .systemd_version }}-talos" \
          -Dselinux=enabled \
          -Dblkid=enabled \
          -Dkmod=enabled \
          -Dopenssl=disabled \
          -Dgshadow=false -Didn=false -Dlocaled=false \
          -Dnss-myhostname=false \
          -Dnss-mymachines=false \
          -Dnss-resolve=false \
          -Dsysusers=false \
          -Dutmp=false \
          -Duserdb=false \
          -Ddbus=disabled \
          -Dglib=disabled \
          -Dnss-mymachines=disabled \
          -Dnss-myhostname=false \
          -Dnss-resolve=disabled \
          -Dnss-systemd=false \
          -Dbacklight=false \
          -Dbinfmt=false \
          -Dbpf-framework=disabled \
          -Dcoredump=false \
          -Denvironment-d=false \
          -Dfirstboot=false \
          -Dhibernate=false \
          -Dhostnamed=false \
          -Dlink-udev-shared=false \
          -Dlogind=false \
          -Dmachined=false \
          -Dnetworkd=false \
          -Doomd=false \
          -Dportabled=false \
          -Dsysext=false \
          -Danalyze=false \
          -Dtimedated=false \
          -Dtimesyncd=false \
          -Dtmpfiles=false \
          -Dpolkit=disabled \
          -Dstatic-libudev=true \
          -Dman=disabled \
          -Dtests=false \
          -Dwerror=false \
          -Dsplit-bin=false \
          -Dtranslations=false \
          -Dxdg-autostart=false \
          -Daudit=disabled \
          -Dukify=disabled \
          -Dkernel-install=false \
          -Drfkill=false \
          -Dvmspawn=disabled \
          -Dhomed=disabled \
          -Dremote=disabled \
          -Dmountfsd=false \
          -Dsysupdate=disabled \
          -Dsysupdated=disabled \
          -Dbootloader=enabled \
          -Defi=true \
          -Dsbat-distro-summary="Talos Linux" \
          -Dsbat-distro-url=https://github.com/siderolabs/talos/issues \
          -Dsbat-distro=talos
    build:
      - |
        cd /tmp/systemd
        meson compile -C build
finalize:
  - from: /tmp/systemd
    to: /tmp/systemd
