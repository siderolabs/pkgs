name: systemd
variant: scratch
shell: /bin/bash
dependencies:
  - stage: base
steps:
  - sources:
      - url: https://github.com/systemd/systemd/archive/refs/tags/v{{ .systemd_version }}.tar.gz
        destination: systemd.tar.gz
        sha256: "{{ .systemd_sha256 }}"
        sha512: "{{ .systemd_sha512 }}"
    env:
      SOURCE_DATE_EPOCH: {{ .BUILD_ARG_SOURCE_DATE_EPOCH }}
    prepare:
      - |
        mkdir -p /tmp/systemd
        tar -xzf systemd.tar.gz --strip-components=1 -C /tmp/systemd
        cd /tmp/systemd

        meson setup build \
          --buildtype=release \
          -Dmode=release \
          -Dlibdir=/usr/lib \
          -Dversion-tag="{{ .systemd_version }}-talos" \
          -Dlibc=musl \
          -Dselinux=enabled \
          -Dblkid=enabled \
          -Dkmod=enabled \
          -Dopenssl=disabled \
          -Dgshadow=false \
          -Dutmp=false \
          -Duserdb=false \
          -Ddbus=disabled \
          -Dglib=disabled \
          -Dnss-mymachines=disabled \
          -Dnss-myhostname=false \
          -Dnss-resolve=disabled \
          -Dnss-systemd=false \
          -Dbacklight=false \
          -Dbinfmt=false \
          -Dbpf-framework=disabled \
          -Dcoredump=false \
          -Denvironment-d=false \
          -Dfirstboot=false \
          -Dhibernate=false \
          -Dhostnamed=false \
          -Dlink-udev-shared=false \
          -Dlogind=false \
          -Dmachined=false \
          -Dnetworkd=false \
          -Doomd=false \
          -Dportabled=false \
          -Dsysext=false \
          -Danalyze=false \
          -Dtimedated=false \
          -Dtimesyncd=false \
          -Dtmpfiles=false \
          -Dpolkit=disabled \
          -Dstatic-libudev=true \
          -Dman=disabled \
          -Dtests=false \
          -Dwerror=false \
          -Dsplit-bin=false \
          -Dtranslations=false \
          -Dxdg-autostart=false \
          -Daudit=disabled \
          -Dukify=disabled \
          -Dkernel-install=false \
          -Drfkill=false \
          -Dvmspawn=disabled \
          -Dhomed=disabled \
          -Dremote=disabled \
          -Dmountfsd=false \
          -Dsysupdate=disabled \
          -Dsysupdated=disabled \
          -Dbootloader=enabled \
          -Defi=true \
          -Dsbat-distro-summary="Talos Linux" \
          -Dsbat-distro-url=https://github.com/siderolabs/talos/issues \
          -Dsbat-distro=talos
    build:
      - |
        cd /tmp/systemd
        meson compile -C build
finalize:
  - from: /tmp/systemd
    to: /tmp/systemd
