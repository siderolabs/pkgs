name: containerd
dependencies:
  - image: docker.io/autonomy/base:f9a4941
  - image: docker.io/autonomy/musl:9bc7430
  - image: docker.io/autonomy/ca-certificates:20f39f7
  - image: docker.io/autonomy/libseccomp:80ea634
finalize:
  - from: /rootfs
    to: /
variant: scratch
shell: /toolchain/bin/bash
steps:
  - sources:
      - url: https://github.com/containerd/containerd/archive/v1.2.7.tar.gz
        destination: containerd.tar.gz
        sha256: 7179c709a0d187708a1eeddcbdecd7206b2c642dc4413bcdb049cd6b38d06801
        sha512: b96ca236d28933c1bf309fc7204af7d2c356e19af394d5c2274a178c8f15298faf6ca9bb8e7d04acb7c3c9c41035446643a8df0103017f7ed0320bfc37cb8ca9

    prepare: |
      export GOPATH=/go
      mkdir -p ${GOPATH}/src/github.com/containerd/containerd
      tar -xzf containerd.tar.gz --strip-components=1 -C ${GOPATH}/src/github.com/containerd/containerd

      mkdir /bin
      ln -sv /toolchain/bin/bash /bin/bash
      ln -sv /toolchain/bin/bash /bin/sh
      cp -R /toolchain/lib/gcc /lib
      cp -R /toolchain/lib/libgcc* /lib

    build: |
      export PKG_CONFIG_PATH=/usr/lib/pkgconfig
      export CC=/toolchain/bin/cc
      export CGO_CFLAGS="-L/usr/lib -I/usr/include"
      export CGO_LDFLAGS="-L/usr/lib -I/usr/include"
      # This is required due to "loadinternal: cannot find runtime/cgo".
      export CGO_ENABLED=1
      export GOPATH=/go
      export PATH=${PATH}:${TOOLCHAIN}/go/bin
      cd ${GOPATH}/src/github.com/containerd/containerd
      make bin/containerd bin/containerd-shim BUILDTAGS='seccomp no_btrfs' VERSION=v1.2.6 REVISION=894b81a4b802e4eb2a91d1ce216b8817763c29fb

    install: |
      mkdir -p /rootfs/bin
      export GOPATH=/go
      cp ${GOPATH}/src/github.com/containerd/containerd/bin/containerd /rootfs/bin
      cp ${GOPATH}/src/github.com/containerd/containerd/bin/containerd-shim /rootfs/bin
