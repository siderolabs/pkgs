name: kernel
dependencies:
    - image: docker.io/autonomy/tools:b4e3778
    - image: docker.io/autonomy/ca-certificates:20f39f7
finalize:
    - from: /rootfs
      to: /
variant: scratch
shell: /toolchain/bin/bash
steps:
    - sources:
          - url: https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.2.8.tar.xz
            destination: linux.tar.xz
            sha256: a127cd06cc01468e5564c5242827610b679827d7b40c2a2e4d82c629dd0f6937
            sha512: 89d1b8d5aff901ee86211e1c03adfa912fbbe221e63f54cc7894eea1ff1a10c49dc359a4f097054be43041bec01dcf119af2967cf9ac6eb2198c2af7d0d18a46

      prepare: |
          tar -xJf linux.tar.xz --strip-components=1

          mkdir /bin
          ln -sv /toolchain/bin/bash /bin/bash
          ln -sv /toolchain/bin/bash /bin/sh
          ln -sv /toolchain/lib /lib
          mkdir -p /usr/bin \
              && ln -sf /toolchain/bin/env /usr/bin/env \
              && ln -sf /toolchain/bin/true /bin/true \
              && ln -sf /toolchain/bin/pwd /bin/pwd

          case $ARCH in
              x86_64)
                  make mrproper
                  cp -v /pkg/config-amd64 .config
              ;;
              aarch64)
                  export ARCH=arm64
                  make mrproper
                  cp -v /pkg/config-arm64 .config
              ;;
              *)
                  echo "unsupported arch ${ARCH}"
                  exit 1
              ;;
          esac

      build: |
          case $ARCH in
              x86_64)
              ;;
              aarch64)
                  export ARCH=arm64
              ;;
              *)
                  echo "unsupported arch ${ARCH}"
                  exit 1
              ;;
          esac
          make -j $(nproc)
          make -j $(nproc) modules

      install: |
          mkdir -p /rootfs/boot
          case $ARCH in
              x86_64)
                  mv arch/x86/boot/bzImage /rootfs/boot/vmlinuz
                  mv vmlinux /rootfs/boot/vmlinux
              ;;
              aarch64)
                  export ARCH=arm64
                  mv arch/arm64/boot/Image.gz /rootfs/boot/vmlinuz
                  mv vmlinux /rootfs/boot/vmlinux
              ;;
              *)
                  echo "unsupported arch ${ARCH}"
                  exit 1
              ;;
          esac
          export KERNELRELEASE=$(cat include/config/kernel.release)
          make -j $(nproc) modules_install DEPMOD=/toolchain/bin/depmod INSTALL_MOD_PATH=/rootfs
          depmod -b /rootfs $KERNELRELEASE
          unlink /rootfs/lib/modules/$KERNELRELEASE/build
          unlink /rootfs/lib/modules/$KERNELRELEASE/source
