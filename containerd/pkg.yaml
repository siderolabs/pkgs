name: containerd
variant: scratch
shell: /toolchain/bin/bash
dependencies:
  - stage: base
  - stage: libseccomp
steps:
  - sources:
      - url: https://github.com/containerd/containerd/archive/v1.4.5.tar.gz
        destination: containerd.tar.gz
        sha256: 63da3af809328cd90d3c1544126d30910a9ea9d45ac5eac751cf39d736514eab
        sha512: 2df2e8a08ffc9134bb0fe143bdcd64a4c8bed2fe9d72263da8d9389daff3ed801eec2e5b31caffac1e6245386b8843a5022c456c60c0dcedbaae3d7b74ecb048
    env:
      GO111MODULE: off
    prepare:
      - |
        export GOPATH=/go
        mkdir -p ${GOPATH}/src/github.com/containerd/containerd
        tar -xzf containerd.tar.gz --strip-components=1 -C ${GOPATH}/src/github.com/containerd/containerd
    build:
      - |
        export PKG_CONFIG_PATH=/usr/lib/pkgconfig
        export CC=/toolchain/bin/cc
        # This is required due to "loadinternal: cannot find runtime/cgo".
        export CGO_ENABLED=1
        export GOPATH=/go
        export PATH=${PATH}:${TOOLCHAIN}/go/bin
        cd ${GOPATH}/src/github.com/containerd/containerd
        make bin/containerd bin/containerd-shim bin/containerd-shim-runc-v2 BUILDTAGS='seccomp no_btrfs' VERSION=v1.4.5 REVISION=8263eb3eaee447b16856eeb8839d5df4c9cca71a
    install:
      - |
        mkdir -p /rootfs/bin
        export GOPATH=/go
        cp ${GOPATH}/src/github.com/containerd/containerd/bin/containerd /rootfs/bin
        cp ${GOPATH}/src/github.com/containerd/containerd/bin/containerd-shim /rootfs/bin
        cp ${GOPATH}/src/github.com/containerd/containerd/bin/containerd-shim-runc-v2 /rootfs/bin
finalize:
  - from: /rootfs
    to: /
